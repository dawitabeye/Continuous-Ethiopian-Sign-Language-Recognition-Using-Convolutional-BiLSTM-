# Proxmox VE + Onsite PBS + Offsite PBS Setup Guide
# =================================================
# Assumptions:
# - 1 PVE host: IP 192.168.100.10
# - 1 Onsite PBS: IP 192.168.100.20
# - 1 Offsite PBS: IP 10.10.10.20
# - All systems use ZFS with RAIDZ
# - Datastore name: main-pbs01-backup
# - Namespace: main-pbs01-backup-ns

# ---------- Step 1: Prepare PVE ----------
# Ensure ZFS pool for VMs exists
zpool create main-pve01-vm raidz /dev/sdX /dev/sdY /dev/sdZ

# ---------- Step 2: Onsite PBS Setup ----------
# Create ZFS pool for backup storage
zpool create zfs-pool-01 raidz /dev/sdX /dev/sdY /dev/sdZ

# Enable compression
zfs set compression=zstd zfs-pool-01

# Create datastore mount point
mkdir -p /mnt/datastore/main-pbs01-backup

# Add datastore to PBS
proxmox-backup-manager datastore create main-pbs01-backup --path /mnt/datastore/main-pbs01-backup

# Create namespace
proxmox-backup-manager datastore namespace create main-pbs01-backup-ns --datastore main-pbs01-backup

# ---------- Step 3: Offsite PBS Setup ----------
# Repeat same setup as onsite PBS

# Create ZFS pool for replication storage
zpool create zfs-pool-remote raidz /dev/sdX /dev/sdY /dev/sdZ

# Enable compression
zfs set compression=zstd zfs-pool-remote

# Create datastore mount point
mkdir -p /mnt/datastore/main-pbs01-backup

# Add datastore to PBS
proxmox-backup-manager datastore create main-pbs01-backup --path /mnt/datastore/main-pbs01-backup

# Create matching namespace
proxmox-backup-manager datastore namespace create main-pbs01-backup-ns --datastore main-pbs01-backup

# ---------- Step 4: Connect Onsite PBS to Offsite PBS ----------
# On the onsite PBS Web GUI or via CLI, create sync job

# Example command:
proxmox-backup-manager sync-job create offsite-sync \
  --remote offsite-pbs \
  --remote-store main-pbs01-backup \
  --remote-ns main-pbs01-backup-ns \
  --store main-pbs01-backup \
  --ns main-pbs01-backup-ns \
  --schedule "daily"

# Add remote connection config:
proxmox-backup-manager remote create offsite-pbs \
  --host 10.10.10.20 \
  --user root@pam

# Run a test sync manually (optional)
proxmox-backup-client sync offsite-sync

# ---------- Step 5: Add PBS Storage to PVE ----------
# From PVE Web GUI:
# Datacenter > Storage > Add > Proxmox Backup Server

# Fill in:
# ID: main-pbs01-backup-ns
# Server: 192.168.100.20
# Username: root@pam
# Password: (PBS root password)
# Datastore: main-pbs01-backup
# Namespace: main-pbs01-backup-ns
# Fingerprint: (copy from PBS Web UI: Access > TLS Certificates)

# ---------- Step 6: Create Backup Job in PVE ----------
# From PVE Web GUI:
# Datacenter > Backup > Add

# Set:
# - Storage: main-pbs01-backup-ns
# - Mode: Snapshot
# - Compression: zstd
# - Schedule: daily or weekly
# - VM/CT: Select all to include
# - Enable email notification (optional)

# ---------- Step 7: Monitor Backups ----------
# View backups from:
# - PBS Web UI > Datastore > main-pbs01-backup > main-pbs01-backup-ns
# - PVE Web UI > Datacenter > Backup or each VM > Backup tab

# ---------- Step 8: Test Backup and Restore ----------
# Backup:
# - Manually trigger from PVE or wait for schedule

# Restore:
# - From PVE Web UI > VM > Backup > Restore
# - Or from PBS Web UI > Restore > Select VM/CT > Restore to PVE

# ---------- Final Notes ----------
# - Ensure PBS nodes are time-synced (use NTP)
# - Regularly test restores
# - Secure root passwords and access
# - Use firewall rules or VPN between PVE and PBS nodes
